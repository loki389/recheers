# 🗄️ Vercel KV 配置指南 - 调研数据存储

## 📋 为什么需要配置 Vercel KV？

当前项目使用文件系统存储调研数据，这在 Vercel 的无服务器环境中**无法工作**，因为：
- Vercel 的函数是只读文件系统，不能写入文件
- 每次函数调用都在不同的容器中，数据无法持久化

**解决方案**：使用 **Vercel KV**（基于 Redis）来存储调研数据。

---

## 🚀 配置步骤

### 步骤 1：在 Vercel 中创建 KV 数据库

#### 方法 A：从顶部导航栏进入（推荐）

1. **登录 Vercel Dashboard**
   - 访问：https://vercel.com/dashboard
   - 使用 GitHub 账户登录

2. **找到 Storage 入口**
   - 查看顶部导航栏，找到 **"Storage"** 或 **"Stores"** 选项
   - 如果顶部没有，查看左侧边栏
   - 或直接访问：https://vercel.com/dashboard/stores

3. **创建 KV 数据库**
   - 点击 **"Create Database"** 或 **"Add"** 按钮
   - 选择 **"KV"**（Redis 数据库）
   - 输入数据库名称，例如：`survey-data` 或 `ltns-kv`
   - 选择区域（建议选择离用户最近的区域，如 `Southeast Asia (ap-southeast-1)`）
   - 点击 **"Create"**

#### 方法 B：从项目设置中创建

1. **进入项目页面**
   - 在 Dashboard 中点击你的项目名称

2. **进入 Settings**
   - 点击顶部菜单的 **"Settings"**
   - 在左侧菜单中找到 **"Storage"** 或 **"KV"** 选项

3. **创建 KV 数据库**
   - 点击 **"Create Database"** 或 **"Connect Database"**
   - 如果是第一次创建，点击 **"Create New KV Database"**
   - 输入名称并选择区域
   - 点击 **"Create"**

#### 方法 C：在项目部署/导入时创建

1. **导入项目时**
   - 在导入项目页面的 **"Storage"** 部分
   - 可以创建新的 KV 数据库或连接现有的

4. **连接到项目**（如果还没连接）
   - 创建完成后，进入数据库详情页面
   - 在 **"Connect to Project"** 部分
   - 选择你的项目
   - 点击 **"Connect"**
   - **注意**：如果项目还没部署，先部署项目，然后再连接 KV

---

### 步骤 2：配置环境变量（自动配置）

连接 KV 数据库到项目后，Vercel 会自动添加以下环境变量：

- `KV_URL` - KV 数据库连接 URL
- `KV_REST_API_URL` - KV REST API URL
- `KV_REST_API_TOKEN` - KV REST API 令牌
- `KV_REST_API_READ_ONLY_TOKEN` - 只读令牌（可选）

**你不需要手动配置这些变量**，Vercel 会自动处理。

---

### 步骤 3：验证配置

部署项目后，验证 KV 是否正常工作：

1. **测试调研提交**
   - 访问部署的网站
   - 填写并提交调研问卷
   - 如果提交成功，说明 KV 配置正确 ✅

2. **检查数据面板**
   - 提交后，刷新数据面板
   - 应该能看到新提交的数据
   - 统计数据应该更新

3. **查看 Vercel 日志**
   - 如果遇到问题，进入 **"Deployments"** → 点击最新的部署
   - 查看 **"Functions"** 或 **"Runtime Logs"**
   - 查找是否有 KV 连接错误

---

## ⚠️ 重要提示

### 本地开发

本地开发时，代码会自动回退到使用本地 `data/survey.json` 文件，因为：
- 本地环境可能没有 KV 配置
- 代码包含自动回退逻辑

**本地开发无需配置 KV**，可以正常开发和测试。

### 生产环境

**部署到 Vercel 时必须配置 KV**，否则：
- 调研问卷无法提交
- 数据无法保存
- 数据面板无法更新

---

## 📝 费用说明

### Vercel KV 免费额度

- **免费计划**：
  - 256 MB 存储空间
  - 每天 100,000 次读取
  - 每天 100,000 次写入
  
对于调研问卷项目，免费额度通常足够使用。

### 超出限制

如果超出免费额度：
- 可以选择升级到 Pro 计划
- 或者考虑其他存储方案（如 Supabase、MongoDB 等）

---

## 🔍 故障排除

### 问题 1：调研提交失败，提示 "Error saving survey data"

**原因**：KV 数据库未正确配置或未连接到项目

**解决**：
1. 检查 Vercel Storage 中是否创建了 KV 数据库
2. 确认数据库已连接到项目
3. 重新部署项目

### 问题 2：数据面板显示旧数据，不更新

**原因**：KV 数据库为空，需要初始化数据

**解决**：
1. 首次部署时，KV 会自动从本地 `data/survey.json` 初始化
2. 如果数据未初始化，可以手动提交一次调研问卷来创建第一条记录

### 问题 3：本地开发时 KV 相关错误

**原因**：本地环境没有 KV 配置

**解决**：
- 这是正常的，代码会自动使用本地文件
- 如果需要本地测试 KV，可以：
  1. 在 Vercel Dashboard 中复制 KV 的环境变量
  2. 在本地 `.env.local` 文件中添加这些变量

---

## ✅ 配置检查清单

部署前确认：

- [ ] 已在 Vercel 创建 KV 数据库
- [ ] KV 数据库已连接到项目
- [ ] 已部署项目（至少一次）
- [ ] 测试了调研问卷提交功能
- [ ] 验证了数据面板更新功能

---

## 🎉 配置完成

配置完成后，你的网站应该能够：
- ✅ 接收用户提交的调研问卷
- ✅ 将数据保存到 Vercel KV
- ✅ 实时更新数据面板
- ✅ 支持数据筛选和统计

如果遇到其他问题，请查看：
- Vercel 部署日志
- 浏览器控制台错误（F12）
- Vercel KV 文档：https://vercel.com/docs/storage/vercel-kv

