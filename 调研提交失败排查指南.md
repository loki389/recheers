# 🔍 调研提交失败排查指南

## 📋 常见问题检查清单

### 1. 检查环境变量配置

**在 Vercel Dashboard 中检查**：

1. 进入项目 → **Settings** → **Environment Variables**
2. 确认以下环境变量存在：
   - ✅ `UPSTASH_REDIS_REST_URL` - 应该以 `https://` 开头
   - ✅ `UPSTASH_REDIS_REST_TOKEN` - 应该是一串字符

**如果没有这些变量**：
- 检查 Upstash 数据库是否已连接到 Vercel 项目
- 在 Upstash Dashboard 中重新连接
- 或者手动添加环境变量（从 Upstash Dashboard 复制）

### 2. 检查 Upstash 连接

**在 Upstash Dashboard 中**：

1. 登录 https://console.upstash.com/
2. 进入你的 Redis 数据库
3. 检查 **"Vercel Integration"** 部分
4. 确认已连接到正确的 Vercel 项目

### 3. 检查 Vercel 部署日志

**查看错误详情**：

1. 进入 Vercel Dashboard → 你的项目 → **Deployments**
2. 点击最新的部署
3. 查看 **"Functions"** 或 **"Runtime Logs"**
4. 查找以下错误信息：
   - `KV storage not configured`
   - `UPSTASH_REDIS_REST_URL` 相关错误
   - `Error saving survey data`

### 4. 重新部署项目

**重要**：配置环境变量后必须重新部署！

1. 进入 **Deployments** 页面
2. 点击最新部署右侧的 **"..."** 菜单
3. 选择 **"Redeploy"**
4. 等待部署完成

---

## 🔧 手动配置环境变量（如果需要）

如果 Upstash 自动连接失败，可以手动添加：

### 步骤 1：从 Upstash 获取凭证

1. 登录 Upstash Dashboard
2. 进入你的 Redis 数据库
3. 在 **"Details"** 页面找到：
   - **REST URL** - 复制这个值
   - **REST Token** - 复制这个值

### 步骤 2：在 Vercel 中添加环境变量

1. 进入 Vercel 项目 → **Settings** → **Environment Variables**
2. 点击 **"Add New"**
3. 添加第一个变量：
   - **Key**: `UPSTASH_REDIS_REST_URL`
   - **Value**: 从 Upstash 复制的 REST URL
   - **Environment**: 全部勾选（Production、Preview、Development）
4. 点击 **"Save"**
5. 添加第二个变量：
   - **Key**: `UPSTASH_REDIS_REST_TOKEN`
   - **Value**: 从 Upstash 复制的 REST Token
   - **Environment**: 全部勾选
6. 点击 **"Save"**

### 步骤 3：重新部署

1. 进入 **Deployments** 页面
2. 点击 **"Redeploy"**
3. 等待部署完成

---

## 🐛 调试步骤

### 方法 1：查看浏览器控制台

1. 打开网站
2. 按 `F12` 打开开发者工具
3. 切换到 **"Console"** 标签
4. 尝试提交调研问卷
5. 查看是否有错误信息

### 方法 2：查看网络请求

1. 打开开发者工具（F12）
2. 切换到 **"Network"** 标签
3. 尝试提交调研问卷
4. 找到 `/api/survey` 请求
5. 点击查看 **"Response"** 标签
6. 查看错误详情

### 方法 3：检查 Vercel 函数日志

1. 进入 Vercel Dashboard → 项目 → **Functions**
2. 点击 `/api/survey` 函数
3. 查看 **"Logs"** 标签
4. 查找错误信息

---

## ⚠️ 常见错误及解决方案

### 错误 1：`KV storage not configured`

**原因**：环境变量未配置或配置错误

**解决**：
1. 检查环境变量是否存在
2. 确认变量名正确（大小写敏感）
3. 重新部署项目

### 错误 2：`UPSTASH_REDIS_REST_URL is not defined`

**原因**：环境变量未正确传递到运行时

**解决**：
1. 确认环境变量已添加到所有环境（Production、Preview、Development）
2. 重新部署项目
3. 检查 Vercel 函数日志确认环境变量已加载

### 错误 3：`401 Unauthorized` 或 `403 Forbidden`

**原因**：Upstash Token 无效或过期

**解决**：
1. 在 Upstash Dashboard 重新生成 Token
2. 更新 Vercel 环境变量
3. 重新部署

### 错误 4：`Connection timeout` 或网络错误

**原因**：网络连接问题或 Upstash 服务不可用

**解决**：
1. 检查 Upstash Dashboard 中数据库状态
2. 确认数据库区域选择正确
3. 稍后重试

---

## ✅ 验证配置成功

配置完成后，验证：

1. **环境变量检查**
   - [ ] `UPSTASH_REDIS_REST_URL` 存在
   - [ ] `UPSTASH_REDIS_REST_TOKEN` 存在
   - [ ] 两个变量都已添加到所有环境

2. **功能测试**
   - [ ] 可以正常提交调研问卷
   - [ ] 提交后显示成功消息
   - [ ] 数据面板更新显示新数据

3. **日志检查**
   - [ ] Vercel 日志中显示 "Using Upstash Redis"
   - [ ] 没有错误信息
   - [ ] 显示 "Survey data saved successfully"

---

## 🆘 如果还是不行

1. **检查代码版本**
   - 确保已安装最新依赖：`npm install`
   - 确保代码已推送到 GitHub

2. **联系支持**
   - 查看 Vercel 日志获取详细错误信息
   - 查看 Upstash Dashboard 中的数据库状态
   - 检查是否有配额限制

3. **临时解决方案**
   - 如果急需使用，可以暂时使用本地文件存储（开发环境）
   - 但生产环境必须使用 KV 存储

---

需要更多帮助？请告诉我具体的错误信息！

