# 🔍 调试调研提交失败 - 详细步骤

## 📋 第一步：查看浏览器控制台错误

1. **打开网站**
   - 访问你的 Vercel 部署网站

2. **打开开发者工具**
   - 按 `F12` 或右键 → "检查"
   - 切换到 **"Console"** 标签

3. **尝试提交调研问卷**
   - 填写并提交问卷
   - 查看控制台中的错误信息

4. **查看网络请求**
   - 切换到 **"Network"** 标签
   - 找到 `/api/survey` 请求
   - 点击查看 **"Response"** 标签
   - **重要**：查看返回的错误详情

---

## 📋 第二步：查看 Vercel 函数日志

### 方法 A：通过 Functions 页面

1. **进入 Vercel Dashboard**
   - 访问：https://vercel.com/dashboard
   - 选择你的项目

2. **查看 Functions**
   - 点击 **"Functions"** 标签
   - 找到 `/api/survey` 函数
   - 点击进入

3. **查看日志**
   - 切换到 **"Logs"** 标签
   - 尝试提交问卷
   - 查看实时日志输出

### 方法 B：通过 Deployments 页面

1. **进入 Deployments**
   - 点击 **"Deployments"** 标签
   - 点击最新的部署

2. **查看函数日志**
   - 在部署详情页面找到 **"Functions"** 部分
   - 点击 `/api/survey` 函数
   - 查看日志

---

## 📋 第三步：查看关键日志信息

在日志中查找以下信息：

### ✅ 成功的情况

你应该看到：
```
Using Vercel KV with env vars: { hasKV_URL: true, hasKV_REST_API_URL: true, ... }
Attempting to save survey data to KV, record count: X
Survey data saved successfully to KV
```

### ❌ 失败的情况

可能看到：
1. **`KV storage not configured`**
   - 说明环境变量未正确加载
   - 检查环境变量配置

2. **`Failed to import @vercel/kv`**
   - 说明依赖包未安装
   - 需要检查 `package.json`

3. **`Error saving survey data to KV: ...`**
   - 说明 KV 连接有问题
   - 查看具体错误信息

4. **网络错误或超时**
   - 说明 KV 服务不可用
   - 检查 KV 数据库状态

---

## 📋 第四步：检查环境变量

### 在 Vercel Dashboard 中验证

1. **进入项目设置**
   - 项目 → **Settings** → **Environment Variables**

2. **确认环境变量存在**
   - ✅ `KV_URL` 或 `KV_REST_API_URL`
   - ✅ `KV_REST_API_TOKEN`
   - ✅ 这些变量应该应用到所有环境

3. **检查变量值**
   - 点击变量旁边的眼睛图标查看值
   - 确认值不为空

### 在代码中验证

代码现在会在错误信息中显示环境变量状态，查看：
- 浏览器控制台的错误响应
- Vercel 日志中的 `envCheck` 信息

---

## 📋 第五步：常见问题及解决方案

### 问题 1：`KV storage not configured`

**可能原因**：
- 环境变量未正确配置
- 环境变量未应用到所有环境

**解决**：
1. 确认环境变量已添加到所有环境（Production、Preview、Development）
2. 重新部署项目
3. 检查 Vercel 日志确认环境变量已加载

### 问题 2：`Failed to import @vercel/kv`

**可能原因**：
- 依赖包未安装
- `package.json` 未更新

**解决**：
1. 确认 `package.json` 中有 `"@vercel/kv": "^1.0.0"`
2. 推送代码到 GitHub
3. Vercel 会自动安装依赖

### 问题 3：KV 连接超时

**可能原因**：
- KV 数据库区域选择不当
- 网络问题

**解决**：
1. 检查 KV 数据库状态
2. 确认区域选择正确
3. 稍后重试

---

## 📋 第六步：获取详细错误信息

### 从浏览器控制台

1. 提交问卷后，查看控制台
2. 找到错误响应，应该包含：
   ```json
   {
     "error": "Internal server error",
     "details": "具体错误信息",
     "envCheck": {
       "hasKV": true/false,
       "hasUpstash": true/false
     }
   }
   ```

### 从 Vercel 日志

1. 查看 Functions 日志
2. 查找包含以下关键词的日志：
   - `Error submitting survey`
   - `Error details:`
   - `KV client initialization failed`
   - `Error saving survey data`

---

## 🔧 需要我帮助的话

请提供以下信息：

1. **浏览器控制台的错误信息**
   - 特别是 `/api/survey` 的响应内容

2. **Vercel 日志中的错误信息**
   - Functions → `/api/survey` → Logs

3. **环境变量状态**
   - 在 Vercel Dashboard 中看到的变量列表

4. **部署状态**
   - 最新部署是否成功
   - 是否有构建错误

有了这些信息，我可以帮你快速定位问题！

